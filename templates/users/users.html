{% extends "base.html" %}

{% block styles %}
<style>
    .admin-card {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .table-dark {
        background-color: #1e1e1e;
        border: 1px solid #333;
    }

    h2 {
        color: #e63946;
        margin-bottom: 1.5rem;
    }

    .role-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Tabs dark theme */
    .nav-tabs .nav-link {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #bbb;
        margin-right: 4px;
    }

    .nav-tabs .nav-link.active {
        background: #1e1e1e;
        color: #e63946;
        border-bottom-color: transparent;
        font-weight: bold;
    }

    .tab-content {
        background: #1e1e1e;
        border: 1px solid #333;
        border-top: none;
        padding: 1.5rem;
        border-radius: 0 0 8px 8px;
    }
    /* CRITICAL FIX: Prevent base.html and striped rows from hiding icons */
    .toggle-btn {
        background: none !important;
        border: none !important;
        padding: 0 !important;
        display: inline-flex !important;
        flex-direction: column;
        align-items: center;
        vertical-align: middle;
        position: relative;
        z-index: 2; /* Sits above the striped row background */
        transition: transform 0.2s ease-in-out;
    }

    .toggle-btn:hover {
        transform: scale(1.15);
        text-decoration: none !important;
    }

    /* Force the icon colors to stay vivid on dark backgrounds */
    .toggle-btn.text-success i {
        color: #28a745 !important;
        opacity: 1 !important;
    }

    .toggle-btn.text-muted i {
        color: #6c757d !important;
        opacity: 1 !important;
    }

    /* Small label adjustments */
    .toggle-btn small {
        font-size: 0.6rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        margin-top: -2px;
    }

    /* Fix for vanishing text labels */
    .toggle-btn.text-success small {
        color: #28a745 !important;
    }

    .toggle-btn.text-muted small {
        color: #6c757d !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-shield-lock-fill"></i> Admin Panel</h2>
    <a href="/" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Inventory
    </a>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-0" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users-tab" type="button">
            <i class="bi bi-people-fill"></i> Users
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#mechanics-tab" type="button">
            <i class="bi bi-tools"></i> Mechanics
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#sales-tab" type="button">
            <i class="bi bi-cash-stack"></i> Sales
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#audit-tab" type="button">
            <i class="bi bi-clock-history"></i> Audit Trail
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- USERS TAB -->
    <div class="tab-pane fade show active" id="users-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Create New Staff Account</h5>
            <form method="post" class="row g-3">
                <div class="col-md-5">
                    <input name="username" class="form-control" placeholder="New staff username" required>
                </div>
                <div class="col-md-5">
                    <input name="password" type="password" class="form-control" placeholder="Temporary password" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-person-plus-fill"></i> Create
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Created By</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="fw-bold">{{ user.username }}</td>
                        <td>
                            {% if user.role == 'admin' %}
                                <span class="badge bg-danger role-badge">Admin</span>
                            {% else %}
                                <span class="badge bg-secondary role-badge">Staff</span>
                            {% endif %}
                        </td>
                        <td class="text-white-50">{{ user.created_at }}</td>
                        <td class="text-white-50">
                            {% if user.creator_name %}
                                <i class="bi bi-person-badge"></i> {{ user.creator_name }}
                            {% else %}
                                <span class="text-muted small">System</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if user.role == 'admin' %}
                                <span class="text-success small fw-bold">
                                    <i class="bi bi-shield-check"></i> PROTECTED
                                </span>
                            {% else %}
                                <form action="{{ url_for('auth.toggle_user', user_id=user.id) }}" method="POST">
                                    {% if user.is_active == 1 %}
                                        <button type="submit" class="toggle-btn p-0 text-success">
                                            <i class="bi bi-toggle-on fs-4"></i>
                                            <small class="d-block">ACTIVE</small>
                                        </button>
                                    {% else %}
                                        <button type="submit" class="toggle-btn p-0 text-muted">
                                            <i class="bi bi-toggle-off fs-4"></i>
                                            <small class="d-block">DISABLED</small>
                                        </button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- MECHANICS TAB -->
    <div class="tab-pane fade" id="mechanics-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Add New Mechanic</h5>
            <form action="{{ url_for('auth.add_mechanic') }}" method="POST" class="row g-3">
                <div class="col-md-5">
                    <input name="name" class="form-control" placeholder="Mechanic Name" required>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-white-50">Rate</span>
                        <select name="commission" class="form-select border-secondary text-white bg-dark">
                            <option value="0.80">80%</option>
                            <option value="0.50">50%</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <input name="phone" class="form-control" placeholder="Phone #">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-plus-circle"></i> Add
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Standard Rate</th>
                        <th>Phone</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mechanic in mechanics %}
                    <tr>
                        <td class="fw-bold">{{ mechanic.name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-warning">
                                {{ (mechanic.commission_rate * 100)|int }}%
                            </span>
                        </td>
                        <td class="text-white-50">{{ mechanic.phone or '---' }}</td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_mechanic', mechanic_id=mechanic.id) }}" method="POST">
                                {% if mechanic.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success" title="Click to Disable">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block fw-bold" style="font-size: 0.65rem;">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn p-0 text-muted" title="Click to Activate">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block fw-bold" style="font-size: 0.65rem;">INACTIVE</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No mechanics added yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SALES TAB -->
    <div class="tab-pane fade" id="sales-tab">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead class="table-danger text-dark">
                    <tr>
                        <th>Date & Time</th>
                        <th>Receipt #</th>
                        <th>Customer</th>
                        <th>Payment</th>
                        <th>Total Amount</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_history %}
                    <tr>
                        <td class="text-white-50 small">{{ sale.transaction_date }}</td>
                        <td class="fw-bold text-warning">{{ sale.sales_number }}</td>
                        <td>{{ sale.customer_name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-info">
                                {{ sale.payment_method_name }}
                            </span>
                        </td>
                        <td class="fw-bold text-danger">₱{{ "{:,.2f}".format(sale.total_amount) }}</td>
                        <td class="text-center">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-info me-1" 
                                    onclick="viewSaleDetails('{{ sale.id }}', '{{ sale.sales_number }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <a href="/print_receipt/{{ sale.sales_number }}" target="_blank" class="btn btn-sm btn-outline-warning">
                                <i class="bi bi-printer"></i>
                            </a>
                        </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No sales recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- AUDIT TAB -->
        <div class="tab-pane fade" id="audit-tab">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr class="border-bottom border-secondary">
                            <th>Date & Time</th>
                            <th>Item Summary</th>
                            <th class="text-center">Movement</th>
                            <th>Reason</th>
                            <th class="text-center">Qty</th>
                            <th>Reference</th>
                            <th>Staff</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in history %}
                        <tr>
                            <td class="text-white-50 small">{{ log.transaction_date }}</td>
                            <td>
                                <div class="fw-bold text-white">{{ log.items_summary[:40] }}{% if log.items_summary|length > 40 %}...{% endif %}</div>
                            </td>
                            <td class="text-center">
                                {% set type = log.transaction_type|upper %}
                                {% set display_type = log.transaction_type|replace('_', ' ')|upper %}
                                
                                {# RED PILL: If it's a Sale or specifically says 'OUT' #}
                                {% if type == 'SALE' or type == 'OUT' or type == 'REMOVE' %}
                                    <span class="badge rounded-pill bg-danger px-3 py-2" style="min-width: 80px;">
                                        <i class="bi bi-box-arrow-up me-1"></i> OUT
                                    </span>

                                {# GREEN PILL: If it's a Restock or says 'IN' #}
                                {% elif type in ['RESTOCK', 'IN', 'ADD', 'RECEIVED'] %}
                                    <span class="badge rounded-pill bg-success px-3 py-2" style="min-width: 80px;">
                                        <i class="bi bi-box-arrow-in-down me-1"></i> IN
                                    </span>

                                {# GRAY PILL: Fallback for anything else #}
                                {% else %}
                                    <span class="badge rounded-pill bg-secondary px-3 py-2" style="min-width: 80px;">
                                        {{ log.transaction_type }}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="text-white-50 small fst-italic fw-bold">
                                    {{ log.change_reason and log.change_reason|replace('_', ' ') or '<span class="text-muted fw-bold">No reason provided</span>'|safe }}
                                </span>
                            </td>
                            <td class="text-center fw-bold">{{ log.total_qty }}</td>
                            <td>
                                {% if log.reference_id %}
                                    {# 1st Arg: reference_id (for the DB fetch) | 2nd Arg: sales_number or ID (for the UI) #}
                                    <button class="btn btn-sm btn-outline-info border-0" 
                                            onclick="viewSaleDetails('{{ log.reference_id }}', '{{ log.sales_number or log.reference_id }}')">
                                        <i class="bi bi-hash"></i> {{ log.sales_number or log.reference_id }}
                                    </button>
                                {% else %}
                                    <span class="text-muted">---</span>
                                {% endif %}
                            </td>
                            <td class="text-white-50 small"><i class="bi bi-person"></i> {{ log.user_name }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    <!-- SALES MODAL -->
    <div class="modal fade" id="saleDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Sale Details: #<span id="modalSaleID"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th class="text-center">Price (₱)</th>
                                <th class="text-center">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="saleItemsList">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
function viewSaleDetails(saleID, displayNum) {
    document.getElementById('modalSaleID').innerText = displayNum || saleID;
    const list = document.getElementById('saleItemsList');
    list.innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';
    
    const myModal = new bootstrap.Modal(document.getElementById('saleDetailsModal'));
    myModal.show();

    fetch(`/sales/details/${saleID}`)
        .then(response => response.json())
        .then(data => {
            list.innerHTML = '';
            
            // 1. Show Physical Items
            data.items.forEach(item => {
                let hasDisc = item.discount_amount && item.discount_amount > 0;
                let itemLabel = `<div>${item.name}</div>`;
                if(hasDisc) {
                    itemLabel += `<small class="text-success">Disc: -₱${item.discount_amount.toFixed(2)}</small>`;
                }
                
                let priceDisplay = `<div>₱${parseFloat(item.original_price).toFixed(2)}</div>`;
                if(hasDisc) {
                    priceDisplay += `<div class="text-success fw-bold">₱${parseFloat(item.final_unit_price).toFixed(2)}</div>`;
                }

                list.innerHTML += `
                    <tr>
                        <td>${itemLabel}</td>
                        <td class="text-center align-middle">${priceDisplay}</td>
                        <td class="text-center align-middle fw-bold text-warning">${item.quantity}</td>
                    </tr>`;
            });

            // 2. Show Services/Labor
            if(data.services && data.services.length > 0) {
                let mechanicLabel = data.mechanic ? ` (by ${data.mechanic})` : '';
                list.innerHTML += `<tr class="table-dark"><td colspan="3" class="text-info fw-bold border-top border-secondary">Labor & Services${mechanicLabel}</td></tr>`;
                data.services.forEach(svc => {
                    list.innerHTML += `
                        <tr>
                            <td>${svc.name}</td>
                            <td class="text-center">₱${parseFloat(svc.price).toFixed(2)}</td>
                            <td class="text-center text-muted">1</td>
                        </tr>`;
                });
            }

            // 3. The Golden Total Row with Payment Badge
            const badgeMap = {
            'Cash': 'bg-success',
            'Utang': 'bg-warning'
            };
            let badgeClass = badgeMap[data.payment_method] || 'bg-primary';
            
            list.innerHTML += `
                <tr class="border-top border-danger">
                    <td class="fw-bold pt-3 text-danger">
                        GRAND TOTAL 
                        <span class="badge ${badgeClass} ms-2" style="font-size: 0.65rem; vertical-align: middle;">
                            ${data.payment_method}
                        </span>
                    </td>
                    <td class="pt-3 fw-bold fs-5 text-danger text-center">
                        ₱${parseFloat(data.total_amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                    </td>
                    <td></td>
                </tr>`;
        });
}
</script>
{% endblock %}