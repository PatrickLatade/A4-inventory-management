{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<style>
    .admin-card {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .table-dark {
        background-color: #1e1e1e;
        border: 1px solid #333;
    }

    h2 {
        color: #e63946;
        margin-bottom: 1.5rem;
    }

    .role-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Tabs dark theme */
    .nav-tabs .nav-link {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #bbb;
        margin-right: 4px;
    }

    .nav-tabs .nav-link.active {
        background: #1e1e1e;
        color: #e63946;
        border-bottom-color: transparent;
        font-weight: bold;
    }

    .tab-content {
        background: #1e1e1e;
        border: 1px solid #333;
        border-top: none;
        padding: 1.5rem;
        border-radius: 0 0 8px 8px;
    }
    /* CRITICAL FIX: Prevent base.html and striped rows from hiding icons */
    .toggle-btn {
        background: none !important;
        border: none !important;
        padding: 0 !important;
        display: inline-flex !important;
        flex-direction: column;
        align-items: center;
        vertical-align: middle;
        position: relative;
        z-index: 2; /* Sits above the striped row background */
        transition: transform 0.2s ease-in-out;
    }

    .toggle-btn:hover {
        transform: scale(1.15);
        text-decoration: none !important;
    }

    /* Force the icon colors to stay vivid on dark backgrounds */
    .toggle-btn.text-success i {
        color: #28a745 !important;
        opacity: 1 !important;
    }

    .toggle-btn.text-muted i {
        color: #6c757d !important;
        opacity: 1 !important;
    }

    /* Small label adjustments */
    .toggle-btn small {
        font-size: 0.6rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        margin-top: -2px;
    }

    /* Fix for vanishing text labels */
    .toggle-btn.text-success small {
        color: #28a745 !important;
    }

    .toggle-btn.text-muted small {
        color: #6c757d !important;
    }

    #newCategoryInput:disabled {
    background-color: #121212 !important; /* Very dark/black background */
    color: #555 !important;              /* Dimmed text color */
    border-color: #333 !important;        /* Darker border */
    cursor: not-allowed;                  /* Shows the "stop" cursor */
    opacity: 1;                           /* Prevents browser-default transparency */
    }

    #newCategoryInput:not(:disabled) {
    border-color: #e63946; /* Match your red theme when active */
    }

    #newCategoryInput {
    transition: all 0.3s ease;
    }

    #newCategoryInput:required {
    border-left: 4px solid #e63946; /* Visual hint that this is now mandatory */
    }

    .audit-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 110px;
    height: 36px;
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.6px;
    border-radius: 50px;
    }

    /* Debt accordion row hover */
    .debt-parent-row:hover {
        background: rgba(193, 18, 31, 0.08) !important;
        transition: background 0.15s ease;
    }

    .debt-parent-row:hover .debt-chevron {
        color: var(--bs-warning) !important;
    }

    .debt-chevron {
        display: inline-block;         /* <-- important */
        transform: rotate(0deg);       /* <-- explicit initial state */
        transform-origin: 50% 50%;
        font-size: 0.9rem;
        color: #555;
        transition: transform 0.2s ease, color 0.15s ease;
    }

    .debt-expand-hint {
        font-size: 0.65rem;
        color: #555;
        letter-spacing: 0.4px;
        display: block;
        margin-top: 2px;
        transition: color 0.15s ease;
    }

    .debt-parent-row:hover .debt-expand-hint {
        color: #888;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-shield-lock-fill"></i> Admin Panel</h2>
    <a href="/" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Inventory
    </a>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-0" role="tablist">
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'users-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#users-tab" type="button">
            <i class="bi bi-people-fill"></i> Users
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'mechanics-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#mechanics-tab" type="button">
            <i class="bi bi-tools"></i> Mechanics
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'manage-services-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#manage-services-tab" type="button">
            <i class="bi bi-gear-wide-connected"></i> Services
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'payment-methods-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#payment-methods-tab" type="button">
            <i class="bi bi-credit-card-2-front"></i> Payment Methods
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'sales-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#sales-tab" type="button">
            <i class="bi bi-cash-stack"></i> Sales
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'debt-audit-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#debt-audit-tab" type="button">
            <i class="bi bi-cash-coin"></i> Debt Payments
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'audit-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#audit-tab" type="button">
            <i class="bi bi-clock-history"></i> Audit Trail
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- USERS TAB -->
    <div class="tab-pane fade {% if active_tab == 'users-tab' %}show active{% endif %}" id="users-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Create New Staff Account</h5>
            <form method="post" class="row g-3">
                <div class="col-md-5">
                    <input name="username" class="form-control" placeholder="New staff username" required>
                </div>
                <div class="col-md-5">
                    <input name="password" type="password" class="form-control" placeholder="Temporary password" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-person-plus-fill"></i> Create
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Created By</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="fw-bold">{{ user.username }}</td>
                        <td>
                            {% if user.role == 'admin' %}
                                <span class="badge bg-danger role-badge">Admin</span>
                            {% else %}
                                <span class="badge bg-secondary role-badge">Staff</span>
                            {% endif %}
                        </td>
                        <td class="text-white-50">{{ user.created_at }}</td>
                        <td class="text-white-50">
                            {% if user.creator_name %}
                                <i class="bi bi-person-badge"></i> {{ user.creator_name }}
                            {% else %}
                                <span class="text-muted small">System</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if user.role == 'admin' %}
                                <span class="text-success small fw-bold">
                                    <i class="bi bi-shield-check"></i> PROTECTED
                                </span>
                            {% else %}
                                <form action="{{ url_for('auth.toggle_user', user_id=user.id) }}" method="POST">
                                    {% if user.is_active == 1 %}
                                        <button type="submit" class="toggle-btn p-0 text-success">
                                            <i class="bi bi-toggle-on fs-4"></i>
                                            <small class="d-block">ACTIVE</small>
                                        </button>
                                    {% else %}
                                        <button type="submit" class="toggle-btn p-0 text-muted">
                                            <i class="bi bi-toggle-off fs-4"></i>
                                            <small class="d-block">DISABLED</small>
                                        </button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- MECHANICS TAB -->
    <div class="tab-pane fade {% if active_tab == 'mechanics-tab' %}show active{% endif %}" id="mechanics-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Add New Mechanic</h5>
            <form action="{{ url_for('auth.add_mechanic') }}" method="POST" class="row g-3">
                <div class="col-md-5">
                    <input name="name" class="form-control" placeholder="Mechanic Name" required>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-white-50">Rate</span>
                        <select name="commission" class="form-select border-secondary text-white bg-dark">
                            <option value="0.80">80%</option>
                            <option value="0.50">50%</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <input name="phone" class="form-control" placeholder="Phone #">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-plus-circle"></i> Add
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Standard Rate</th>
                        <th>Phone</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mechanic in mechanics %}
                    <tr>
                        <td class="fw-bold">{{ mechanic.name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-warning">
                                {{ (mechanic.commission_rate * 100)|int }}%
                            </span>
                        </td>
                        <td class="text-white-50">{{ mechanic.phone or '---' }}</td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_mechanic', mechanic_id=mechanic.id) }}" method="POST">
                                {% if mechanic.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success" title="Click to Disable">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block fw-bold" style="font-size: 0.65rem;">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn p-0 text-muted" title="Click to Activate">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block fw-bold" style="font-size: 0.65rem;">INACTIVE</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No mechanics added yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SERVICES TAB -->
    <div class="tab-pane fade {% if active_tab == 'manage-services-tab' %}show active{% endif %}" id="manage-services-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Add New Labor/Service Type</h5>
            <form action="{{ url_for('auth.add_service') }}" method="POST" class="row g-3">
                <div class="col-md-4">
                    <input name="name" class="form-control" placeholder="Service Name (e.g. Brake Clean)" required>
                </div>
                <div class="col-md-3">
                    <select name="existing_category" id="categorySelect" class="form-select bg-dark text-white border-secondary">
                        <option value="Labor">Labor</option> 
                        {% for cat in categories %}
                            {% if cat.category != 'Labor' %}
                                <option value="{{ cat.category }}">{{ cat.category }}</option>
                            {% endif %}
                        {% endfor %}
                        <option value="__OTHER__">-- New Category --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input name="new_category" id="newCategoryInput" class="form-control" placeholder="Select '-- New Category --' to type" disabled>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>
            </form>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-white-50">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" id="serviceSearch" class="form-control bg-dark text-white border-secondary" 
                        placeholder="Search services (e.g. 'change oil')..." onkeyup="filterServices()">
                </div>
                <small class="text-muted">Showing up to 20 results from the master list.</small>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Service Name</th>
                        <th>Category</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="servicesBody">
                    {% for svc in services_list %}
                    <tr>
                        <td class="fw-bold">{{ svc.name }}</td>
                        <td><span class="badge bg-dark border border-secondary text-info">{{ svc.category }}</span></td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_service', service_id=svc.id) }}" method="POST">
                                {% if svc.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn text-muted">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block">DISABLED</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">No services configured yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAYMENT METHODS TAB -->
    <div class="tab-pane fade {% if active_tab == 'payment-methods-tab' %}show active{% endif %}" id="payment-methods-tab">

    <div class="admin-card shadow-sm">
        <h5 class="mb-3 text-white-50">Add New Payment Method</h5>
        <form action="{{ url_for('auth.add_payment_method') }}" method="POST" class="row g-3">
            <div class="col-md-6">
                <input name="name" class="form-control" placeholder="Payment Method Name (e.g. Metrobank)" required>
            </div>
            <div class="col-md-4">
                <select name="category" class="form-select bg-dark text-white border-secondary" required>
                    <option value="Bank">Bank</option>
                    <option value="Cash">Cash</option>
                    <option value="Debt">Debt</option>
                    <option value="Online">Online</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-danger w-100">
                    <i class="bi bi-plus-circle"></i> Add
                </button>
            </div>
        </form>
    </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pm in payment_methods %}
                    <tr>
                        <td class="fw-bold">{{ pm.name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-info">
                                {{ pm.category }}
                            </span>
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_payment_method', pm_id=pm.id) }}" method="POST">
                                {% if pm.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn text-muted">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block">DISABLED</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No payment methods configured yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SALES TAB -->
    <div class="tab-pane fade {% if active_tab == 'sales-tab' %}show active{% endif %}" id="sales-tab">

        <!-- Controls row -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-3 gap-3">

            <div class="d-flex align-items-center gap-3">
                <h6 class="text-danger fw-semibold fs-5 mb-0">
                    <i class="bi bi-cash-stack me-2"></i> Sales History
                </h6>
                <span class="text-danger small" id="sales-summary"></span>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">

                <!-- Search -->
                <div class="input-group input-group-sm" style="width: 220px;">
                    <span class="input-group-text" style="background:#141720; border-color:#333; color:#888;">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" id="sales-search-input"
                        class="form-control form-control-sm"
                        placeholder="Receipt # or customer..."
                        style="background:#141720; border-color:#333; color:#fff;">
                </div>

                <!-- Date range -->
                <div class="input-group input-group-sm" style="width: 240px;">
                    <span class="input-group-text" style="background:#141720; border-color:#333; color:#888;">
                        <i class="bi bi-calendar-range"></i>
                    </span>
                    <input type="text" id="sales-date-range"
                        class="form-control form-control-sm"
                        placeholder="Pick date range..."
                        style="background:#141720; border-color:#333; color:#fff;"
                        readonly>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearSalesFilters()" title="Clear all filters">
                    <i class="bi bi-x-lg"></i>
                </button>

            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle" style="table-layout: fixed; width: 100%;">
                <thead class="table-danger text-dark">
                    <tr>
                        <th style="width:18%;">Date & Time</th>
                        <th style="width:15%;">Receipt #</th>
                        <th style="width:22%;">Customer</th>
                        <th style="width:13%;">Payment</th>
                        <th style="width:12%;">Status</th>
                        <th style="width:12%;">Total</th>
                        <th style="width:8%; text-align:center;">Action</th>
                    </tr>
                </thead>
                <tbody id="sales-admin-body">
                    <tr><td colspan="7" class="text-center text-muted py-4">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3" id="sales-pagination-row" style="display:none !important;">
            <span class="text-muted small" id="sales-page-label"></span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="sales-prev-btn" onclick="salesChangePage(-1)">
                    <i class="bi bi-chevron-left"></i> Prev
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="sales-next-btn" onclick="salesChangePage(1)">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- DEBT PAYMENTS TAB -->
    <div class="tab-pane fade {% if active_tab == 'debt-audit-tab' %}show active{% endif %}" id="debt-audit-tab">

        <!-- Controls row -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-3 gap-3">

            <!-- Left: Title + summary count -->
            <div class="d-flex align-items-center gap-3">
                <h6 class="text-warning fw-semibold fs-5 mb-0">
                    <i class="bi bi-cash-coin me-2"></i> Debt Payment History
                </h6>
                <span class="text-warning small" id="debt-audit-summary"></span>
            </div>

            <!-- Right: Toggle + Date Filter -->
            <div class="d-flex align-items-center gap-2 flex-wrap">

                <!-- Status toggle -->
                <div class="btn-group btn-group-sm" id="debt-status-toggle">
                    <button type="button" class="btn btn-outline-secondary active" data-filter="unpaid"
                            onclick="setDebtFilter('unpaid', this)">
                        <i class="bi bi-exclamation-circle me-1"></i>Unpaid
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="all"
                            onclick="setDebtFilter('all', this)">
                        All
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="paid"
                            onclick="setDebtFilter('paid', this)">
                        <i class="bi bi-check-circle me-1"></i>Paid
                    </button>
                </div>

                <!-- Date range picker -->
                <div class="input-group input-group-sm" style="width: 240px;">
                    <span class="input-group-text" style="background:#141720; border-color:#333; color:#888;">
                        <i class="bi bi-calendar-range"></i>
                    </span>
                    <input type="text" id="debt-date-range"
                        class="form-control form-control-sm"
                        placeholder="Pick date range..."
                        style="background:#141720; border-color:#333; color:#fff;"
                        readonly>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="applyDebtDateFilter()" title="Apply filter">
                    <i class="bi bi-search"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearDebtDateFilter()" title="Clear dates">
                    <i class="bi bi-x-lg"></i>
                </button>

            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark align-middle" id="debt-audit-table">
                <thead>
                    <tr class="border-bottom border-secondary">
                        <th width="3%"></th>
                        <th>Customer</th>
                        <th>Receipt #</th>
                        <th>Date</th>
                        <th class="text-end">Total Debt</th>
                        <th class="text-end">Total Paid</th>
                        <th class="text-end">Remaining</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="debt-audit-body">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- AUDIT TAB -->
    <div class="tab-pane fade {% if active_tab == 'audit-tab' %}show active{% endif %}" id="audit-tab">

        <!-- Controls row -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-3 gap-3">

            <!-- Left: Title + count -->
            <div class="d-flex align-items-center gap-3">
                <h6 class="text-info fw-semibold fs-5 mb-0">
                    <i class="bi bi-truck me-2"></i> Item Movement
                </h6>
                <span class="text-info small" id="audit-summary"></span>
            </div>

            <!-- Right: Filters -->
            <div class="d-flex align-items-center gap-2 flex-wrap">

                <!-- Movement type toggle -->
                <div class="btn-group btn-group-sm" id="audit-type-toggle">
                    <button type="button" class="btn btn-outline-secondary active" 
                            onclick="setAuditType(null, this)">All</button>
                    <button type="button" class="btn btn-outline-success"
                            onclick="setAuditType('IN', this)">
                        <i class="bi bi-box-arrow-in-down me-1"></i>IN
                    </button>
                    <button type="button" class="btn btn-outline-danger"
                            onclick="setAuditType('OUT', this)">
                        <i class="bi bi-box-arrow-up me-1"></i>OUT
                    </button>
                    <button type="button" class="btn btn-outline-info"
                            onclick="setAuditType('ORDER', this)">
                        <i class="bi bi-clipboard-check me-1"></i>ORDER
                    </button>
                </div>

                <!-- Date range picker -->
                <div class="input-group input-group-sm" style="width: 240px;">
                    <span class="input-group-text" style="background:#141720; border-color:#333; color:#888;">
                        <i class="bi bi-calendar-range"></i>
                    </span>
                    <input type="text" id="audit-date-range"
                        class="form-control form-control-sm"
                        placeholder="Pick date range..."
                        style="background:#141720; border-color:#333; color:#fff;"
                        readonly>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearAuditDateFilter()" title="Clear dates">
                    <i class="bi bi-x-lg"></i>
                </button>

            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle" style="table-layout: fixed; width: 100%;">
                <thead>
                    <tr class="border-bottom border-secondary">
                        <th style="width: 13%;">Date & Time</th>
                        <th style="width: 22%;">Item Summary</th>
                        <th style="width: 8%; text-align:center;">Movement</th>
                        <th style="width: 12%;">Reason</th>
                        <th style="width: 5%; text-align:center;">Qty</th>
                        <th style="width: 13%;">Reference</th>
                        <th style="width: 18%;">Notes</th>
                        <th style="width: 9%;">Staff</th>
                    </tr>
                </thead>
                <tbody id="audit-trail-body">
                    <tr><td colspan="8" class="text-center text-muted py-4">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center mt-3" id="audit-pagination-row" style="display:none !important;">
            <span class="text-muted small" id="audit-page-label"></span>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" id="audit-prev-btn" onclick="auditChangePage(-1)">
                    <i class="bi bi-chevron-left"></i> Prev
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="audit-next-btn" onclick="auditChangePage(1)">
                    Next <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

    </div>

    <!-- SALES MODAL -->
    <div class="modal fade" id="saleDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Sale Details: #<span id="modalSaleID"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th class="text-center">Price (₱)</th>
                                <th class="text-center">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="saleItemsList">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDERS MODAL -->
    <div class="modal fade" id="poDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title" id="poModalLabel">Purchase Order Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <!-- Header info -->
            <div class="row mb-4">
            <div class="col-6">
                <small class="text-white-50 d-block">PO NUMBER</small>
                <strong id="modal-po-number" class="text-danger fs-5"></strong>
            </div>
            <div class="col-6 text-end">
                <small class="text-white-50 d-block">STATUS</small>
                <span id="modal-po-status" class="badge"></span>
            </div>
            </div>

            <!-- Vendor & Dates -->
            <div class="row mb-4">
            <div class="col-6">
                <small class="text-white-50 d-block">VENDOR</small>
                <span id="modal-po-vendor"></span>
            </div>
            <div class="col-6 text-end">
                <small class="text-white-50 d-block">ORDER DATE</small>
                <span id="modal-po-order-date"></span>
                <br>
                <small class="text-white-50 d-block mt-2">RECEIVED DATE</small>
                <span id="modal-po-received-date"></span>
            </div>
            </div>

            <!-- Items table -->
            <table class="table table-dark table-hover border-secondary">
            <thead>
                <tr class="text-muted">
                <th>Item Name</th>
                <th class="text-center">Qty</th>
                <th class="text-end">Unit Price</th>
                <th class="text-end">Subtotal</th>
                </tr>
            </thead>
            <tbody id="po-items-list"></tbody>
            <tfoot>
                <tr class="border-top border-danger">
                <td colspan="3" class="fw-bold text-danger pt-3">GRAND TOTAL</td>
                <td id="modal-po-total" class="fw-bold text-danger text-end pt-3 fs-5"></td>
                </tr>
            </tfoot>
            </table>
        </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
let initialServicesHTML = "";
document.addEventListener('DOMContentLoaded', () => {
    initialServicesHTML = document.getElementById('servicesBody').innerHTML;
    
    syncCategoryFields();
});

    const categorySelect = document.getElementById('categorySelect');
    const newCategoryInput = document.getElementById('newCategoryInput');

function syncCategoryFields() {
    const categorySelect = document.getElementById('categorySelect');
    const newCategoryInput = document.getElementById('newCategoryInput');

    if (categorySelect.value === "__OTHER__") {
        // ENABLED STATE
        newCategoryInput.disabled = false;
        newCategoryInput.required = true; // Force validation
        newCategoryInput.placeholder = "Type new category name...";
        newCategoryInput.focus(); // Quality of Life: auto-focus for the user
    } else {
        // DISABLED STATE
        newCategoryInput.value = ""; 
        newCategoryInput.disabled = true;
        newCategoryInput.required = false; // Remove validation
        newCategoryInput.placeholder = "Select '-- New Category --' to type";
    }
}

categorySelect.addEventListener('change', syncCategoryFields);

let searchTimeout;
function filterServices() {
    const query = document.getElementById('serviceSearch').value.trim();
    const tbody = document.getElementById('servicesBody');

    // FIX: If the search box is empty, restore the original 20 items and stop
    if (query.length === 0) {
        tbody.innerHTML = initialServicesHTML;
        return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        // Optional: don't search for just 1 character to save server resources
        if (query.length < 1) return; 

        fetch(`/api/search/services?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = ''; 

                if (data.services.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No services found.</td></tr>';
                    return;
                }

                data.services.forEach(svc => {
                    let statusHtml = svc.is_active === 1 
                        ? `<button type="submit" class="toggle-btn text-success"><i class="bi bi-toggle-on fs-3"></i><small class="d-block">ACTIVE</small></button>`
                        : `<button type="submit" class="toggle-btn text-muted"><i class="bi bi-toggle-off fs-3"></i><small class="d-block">DISABLED</small></button>`;

                    tbody.innerHTML += `
                        <tr class="service-row">
                            <td class="fw-bold service-name">${svc.name}</td>
                            <td><span class="badge bg-dark border border-secondary text-info">${svc.category}</span></td>
                            <td class="text-center">
                                <form action="/services/toggle/${svc.id}" method="POST">
                                    ${statusHtml}
                                </form>
                            </td>
                        </tr>`;
                });
            });
    }, 300);
}

function viewSaleDetails(saleID, displayNum) {
    document.getElementById('modalSaleID').innerText = displayNum || saleID;
    const list = document.getElementById('saleItemsList');
    list.innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';
    
    const myModal = new bootstrap.Modal(document.getElementById('saleDetailsModal'));
    myModal.show();

    fetch(`/sales/details/${saleID}`)
        .then(response => response.json())
        .then(data => {
            list.innerHTML = '';
            
            // 1. Show Physical Items
            data.items.forEach(item => {
                let hasDisc = item.discount_amount && item.discount_amount > 0;
                let itemLabel = `<div>${item.name}</div>`;
                if(hasDisc) {
                    itemLabel += `<small class="text-success">Disc: -₱${item.discount_amount.toFixed(2)}</small>`;
                }
                
                let priceDisplay = `<div>₱${parseFloat(item.original_price).toFixed(2)}</div>`;
                if(hasDisc) {
                    priceDisplay += `<div class="text-success fw-bold">₱${parseFloat(item.final_unit_price).toFixed(2)}</div>`;
                }

                list.innerHTML += `
                    <tr>
                        <td>${itemLabel}</td>
                        <td class="text-center align-middle">${priceDisplay}</td>
                        <td class="text-center align-middle fw-bold text-warning">${item.quantity}</td>
                    </tr>`;
            });

            // 2. Show Services/Labor
            if(data.services && data.services.length > 0) {
                let mechanicLabel = data.mechanic ? ` (by ${data.mechanic})` : '';
                list.innerHTML += `<tr class="table-dark"><td colspan="3" class="text-info fw-bold border-top border-secondary">Labor & Services${mechanicLabel}</td></tr>`;
                data.services.forEach(svc => {
                    list.innerHTML += `
                        <tr>
                            <td>${svc.name}</td>
                            <td class="text-center">₱${parseFloat(svc.price).toFixed(2)}</td>
                            <td class="text-center text-muted">1</td>
                        </tr>`;
                });
            }

            // 3. The Golden Total Row with Payment Badge
            const badgeMap = {
            'Cash': 'bg-success',
            'Utang': 'bg-warning'
            };
            let badgeClass = badgeMap[data.payment_method] || 'bg-primary';
            
            list.innerHTML += `
                <tr class="border-top border-danger">
                    <td class="fw-bold pt-3 text-danger">
                        GRAND TOTAL 
                        <span class="badge ${badgeClass} ms-2" style="font-size: 0.65rem; vertical-align: middle;">
                            ${data.payment_method}
                        </span>
                    </td>
                    <td class="pt-3 fw-bold fs-5 text-danger text-center">
                        ₱${parseFloat(data.total_amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                    </td>
                    <td></td>
                </tr>`;
        });
}

function viewOrder(poId) {
    fetch(`/purchase-order/details/${poId}`)
        .then(response => response.json())
        .then(data => {
            const titleEl = document.getElementById('poModalLabel');
            const orderDateEl = document.getElementById('modal-po-order-date');
            const receivedDateEl = document.getElementById('modal-po-received-date');
            const statusEl = document.getElementById('modal-po-status');

            // Title stays generic
            titleEl.innerText = "Purchase Order Details";

            // Dates
            orderDateEl.innerText = data.created_at || '-';
            receivedDateEl.innerText = data.received_at || '-';

            // Status badge
            statusEl.innerText = data.status;
            statusEl.className = `badge ${data.status_class}`;

            // Other header fields
            document.getElementById('modal-po-number').innerText = data.po_number;
            document.getElementById('modal-po-vendor').innerText = data.vendor_name;
            document.getElementById('modal-po-total').innerText = '₱' + parseFloat(data.total_amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Itemized list
            const list = document.getElementById('po-items-list');
            list.innerHTML = data.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center">${item.quantity_ordered}</td>
                    <td class="text-end">₱${parseFloat(item.unit_price).toFixed(2)}</td>
                    <td class="text-end text-info">₱${parseFloat(item.subtotal).toFixed(2)}</td>
                </tr>
            `).join('');

            new bootstrap.Modal(document.getElementById('poDetailsModal')).show();
        })
        .catch(err => {
            console.error("Error fetching PO details:", err);
            alert("Failed to load order details. Please try again.");
        });
}

// --- DEBT TAB STATE ---
let debtAllSales = [];       // full server response, never mutated
let debtActiveFilter = 'unpaid'; // default view is unpaid only
let debtFlatpickr = null; 

document.addEventListener('DOMContentLoaded', () => {
    // Init Flatpickr in range mode on the debt tab input
    debtFlatpickr = flatpickr('#debt-date-range', {
        mode: 'range',
        dateFormat: 'Y-m-d',        // what gets sent to the server
        altInput: true,
        altFormat: 'M j, Y',        // what the user sees
        allowInput: false,
        disableMobile: false,
        onClose: function(selectedDates) {
            // Auto-apply when user finishes picking both dates
            if (selectedDates.length === 2) {
                applyDebtDateFilter();
            }
        }
    });
});

document.querySelector('[data-bs-target="#debt-audit-tab"]').addEventListener('shown.bs.tab', function () {
    // Only fetch if not already loaded (no date filter applied yet)
    if (debtAllSales.length === 0) {
        loadDebtSummary();
    }
});

function loadDebtSummary(startDate = null, endDate = null) {
    const tbody = document.getElementById('debt-audit-body');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-hourglass-split me-1"></i> Loading...</td></tr>';

    let url = '/api/debt/summary';
    const params = [];
    if (startDate) params.push(`start_date=${startDate}`);
    if (endDate)   params.push(`end_date=${endDate}`);
    if (params.length) url += '?' + params.join('&');

    fetch(url)
        .then(r => r.json())
        .then(data => {
            debtAllSales = data.sales || [];
            renderDebtTable();
        })
        .catch(() => {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">Failed to load data.</td></tr>';
        });
}

function setDebtFilter(filter, btn) {
    debtActiveFilter = filter;

    // Update button active state
    document.querySelectorAll('#debt-status-toggle .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');

    renderDebtTable();
}

function applyDebtDateFilter() {
    if (!debtFlatpickr) return;

    const selected = debtFlatpickr.selectedDates;

    // Need both dates selected before fetching
    if (selected.length < 2) return;

    const fmt = d => {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
    };
    const start = fmt(selected[0]);
    const end   = fmt(selected[1]);

    debtAllSales = [];
    loadDebtSummary(start, end);
}

function clearDebtDateFilter() {
    if (debtFlatpickr) debtFlatpickr.clear();
    debtAllSales = [];
    loadDebtSummary();
}

// --- AUDIT TRAIL STATE ---
let auditPage        = 1;
let auditType        = null;   // null = all
let auditFlatpickr   = null;
let auditStartDate   = null;
let auditEndDate     = null;

document.querySelector('[data-bs-target="#audit-tab"]').addEventListener('shown.bs.tab', function () {
    if (auditPage === 1 && document.getElementById('audit-trail-body').textContent.includes('Loading')) {
        loadAuditTrail();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    auditFlatpickr = flatpickr('#audit-date-range', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'M j, Y',
        allowInput: false,
        onClose: function(selectedDates) {
            if (selectedDates.length === 2) {
                const fmt = d => {
                    const y   = d.getFullYear();
                    const m   = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };
                auditStartDate = fmt(selectedDates[0]);
                auditEndDate   = fmt(selectedDates[1]);
                auditPage = 1;
                loadAuditTrail();
            }
        }
    });
});

function setAuditType(type, btn) {
    auditType = type;
    auditPage = 1;
    document.querySelectorAll('#audit-type-toggle .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadAuditTrail();
}

function clearAuditDateFilter() {
    if (auditFlatpickr) auditFlatpickr.clear();
    auditStartDate = null;
    auditEndDate   = null;
    auditPage      = 1;
    loadAuditTrail();
}

function auditChangePage(direction) {
    auditPage += direction;
    loadAuditTrail();
}

function loadAuditTrail() {
    const tbody = document.getElementById('audit-trail-body');
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="bi bi-hourglass-split me-1"></i> Loading...</td></tr>';

    const params = [`page=${auditPage}`];
    if (auditStartDate) params.push(`start_date=${auditStartDate}`);
    if (auditEndDate)   params.push(`end_date=${auditEndDate}`);
    if (auditType)      params.push(`type=${auditType}`);

    fetch(`/api/audit/trail?${params.join('&')}`)
        .then(r => r.json())
        .then(data => renderAuditTrail(data))
        .catch(() => {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-4">Failed to load data.</td></tr>';
        });
}

function renderAuditTrail(data) {
    const tbody      = document.getElementById('audit-trail-body');
    const summaryEl  = document.getElementById('audit-summary');
    const pageLabel  = document.getElementById('audit-page-label');
    const paginationRow = document.getElementById('audit-pagination-row');
    const prevBtn    = document.getElementById('audit-prev-btn');
    const nextBtn    = document.getElementById('audit-next-btn');

    summaryEl.textContent = `${data.total.toLocaleString()} total entries`;

    // Pagination controls
    if (data.total_pages > 1) {
        paginationRow.style.display = 'flex';
        pageLabel.textContent = `Page ${data.page} of ${data.total_pages}`;
        prevBtn.disabled = data.page <= 1;
        nextBtn.disabled = data.page >= data.total_pages;
    } else {
        paginationRow.style.display = 'none';
    }

    if (!data.rows || data.rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No records found.</td></tr>';
        return;
    }

    const typeBadge = {
        'OUT':    `<span class="badge rounded-pill bg-danger audit-badge"><i class="bi bi-box-arrow-up me-1"></i> OUT</span>`,
        'IN':     `<span class="badge rounded-pill bg-success audit-badge"><i class="bi bi-box-arrow-in-down me-1"></i> IN</span>`,
        'ORDER':  `<span class="badge rounded-pill bg-info text-dark audit-badge"><i class="bi bi-clipboard-check-fill me-1"></i> ORDER</span>`,
    };

    tbody.innerHTML = data.rows.map(log => {
        const type    = (log.transaction_type || '').toUpperCase();
        const badge   = typeBadge[type] || `<span class="badge rounded-pill bg-secondary audit-badge">${log.transaction_type}</span>`;
        const reason  = log.change_reason
            ? log.change_reason.replace(/_/g, ' ')
            : '<span class="text-muted fw-bold">—</span>';
        const summary = log.items_summary
            ? (log.items_summary.length > 40 ? log.items_summary.slice(0, 40) + '...' : log.items_summary)
            : '—';
        const notes = log.notes
            ? `<span class="text-info" style="display:block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${log.notes}">
                <i class="bi bi-chat-left-text me-1"></i>${log.notes}
            </span>`
            : '<span class="text-muted">—</span>';

        let refBtn = '<span class="text-muted">---</span>';
        if (log.reference_id) {
            if (log.reference_type === 'PURCHASE_ORDER') {
                refBtn = `<button class="btn btn-sm btn-outline-warning border-0" 
                    style="max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block;"
                    onclick="viewOrder('${log.reference_id}')">
                    <i class="bi bi-box-seam me-1"></i>${log.po_number || log.reference_id}
                </button>`;
            } else {
                refBtn = `<button class="btn btn-sm btn-outline-danger border-0"
                    style="max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; display:block;"
                    onclick="viewSaleDetails('${log.reference_id}', '${log.sales_number || log.reference_id}')">
                    <i class="bi bi-receipt-cutoff me-1"></i>${log.sales_number || log.reference_id}
                </button>`;
            }
        }

        return `
            <tr>
                <td class="text-white-50 small">${log.transaction_date}</td>
                <td><div class="fw-bold text-white">${summary}</div></td>
                <td class="text-center">${badge}</td>
                <td><span class="text-white-50 small fst-italic fw-bold">${reason}</span></td>
                <td class="text-center fw-bold">${log.total_qty}</td>
                <td>${refBtn}</td>
                <td class="text-white-50 small">${notes}</td>
                <td class="text-white-50 small"><i class="bi bi-person me-1"></i>${log.user_name || '—'}</td>
            </tr>`;
    }).join('');
}

// --- SALES TAB STATE ---
let salesPage      = 1;
let salesStartDate = null;
let salesEndDate   = null;
let salesSearch    = '';
let salesSearchTimeout;
let salesFlatpickr = null;

document.querySelector('[data-bs-target="#sales-tab"]').addEventListener('shown.bs.tab', function () {
    if (salesPage === 1 && document.getElementById('sales-admin-body').textContent.includes('Loading')) {
        loadSalesAdmin();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    salesFlatpickr = flatpickr('#sales-date-range', {
        mode: 'range',
        dateFormat: 'Y-m-d',
        altInput: true,
        altFormat: 'M j, Y',
        allowInput: false,
        onClose: function(selectedDates) {
            if (selectedDates.length === 2) {
                const fmt = d => {
                    const y   = d.getFullYear();
                    const m   = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };
                salesStartDate = fmt(selectedDates[0]);
                salesEndDate   = fmt(selectedDates[1]);
                salesPage = 1;
                loadSalesAdmin();
            }
        }
    });

    document.getElementById('sales-search-input').addEventListener('input', function() {
        clearTimeout(salesSearchTimeout);
        salesSearchTimeout = setTimeout(() => {
            salesSearch = this.value.trim();
            salesPage = 1;
            loadSalesAdmin();
        }, 500);
    });
});

function clearSalesFilters() {
    if (salesFlatpickr) salesFlatpickr.clear();
    document.getElementById('sales-search-input').value = '';
    salesStartDate = null;
    salesEndDate   = null;
    salesSearch    = '';
    salesPage      = 1;
    loadSalesAdmin();
}

function salesChangePage(direction) {
    salesPage += direction;
    loadSalesAdmin();
}

function loadSalesAdmin() {
    const tbody = document.getElementById('sales-admin-body');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4"><i class="bi bi-hourglass-split me-1"></i> Loading...</td></tr>';

    const params = [`page=${salesPage}`];
    if (salesStartDate) params.push(`start_date=${salesStartDate}`);
    if (salesEndDate)   params.push(`end_date=${salesEndDate}`);
    if (salesSearch)    params.push(`search=${encodeURIComponent(salesSearch)}`);

    fetch(`/api/admin/sales?${params.join('&')}`)
        .then(r => r.json())
        .then(data => renderSalesAdmin(data))
        .catch(() => {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-4">Failed to load data.</td></tr>';
        });
}

function renderSalesAdmin(data) {
    const tbody         = document.getElementById('sales-admin-body');
    const summaryEl     = document.getElementById('sales-summary');
    const pageLabel     = document.getElementById('sales-page-label');
    const paginationRow = document.getElementById('sales-pagination-row');
    const prevBtn       = document.getElementById('sales-prev-btn');
    const nextBtn       = document.getElementById('sales-next-btn');

    summaryEl.textContent = `${data.total.toLocaleString()} total sales`;

    if (data.total_pages > 1) {
        paginationRow.style.display = 'flex';
        pageLabel.textContent = `Page ${data.page} of ${data.total_pages}`;
        prevBtn.disabled = data.page <= 1;
        nextBtn.disabled = data.page >= data.total_pages;
    } else {
        paginationRow.style.display = 'none';
    }

    if (!data.rows || data.rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No records found.</td></tr>';
        return;
    }

    const statusBadge = {
        'Paid':       `<span class="badge bg-success">Paid</span>`,
        'Partial':    `<span class="badge bg-warning text-dark">Partial</span>`,
        'Unresolved': `<span class="badge bg-danger">Unpaid</span>`,
    };

    tbody.innerHTML = data.rows.map(sale => `
        <tr>
            <td class="text-white-50 small">${sale.transaction_date}</td>
            <td class="fw-bold text-warning" style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${sale.sales_number || '—'}</td>
            <td style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${sale.customer_name || 'Walk-in'}</td>
            <td>
                <span class="badge bg-dark border border-secondary text-info">
                    ${sale.payment_method_name || '—'}
                </span>
            </td>
            <td>${statusBadge[sale.status] || `<span class="badge bg-secondary">${sale.status}</span>`}</td>
            <td class="fw-bold text-danger">₱${parseFloat(sale.total_amount).toLocaleString(undefined, {minimumFractionDigits:2})}</td>
            <td class="text-center">
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-info me-1"
                            onclick="viewSaleDetails('${sale.id}', '${sale.sales_number}')">
                        <i class="bi bi-eye"></i>
                    </button>
                    <a href="/print_receipt/${sale.sales_number}" target="_blank"
                    class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-printer"></i>
                    </a>
                </div>
            </td>
        </tr>`).join('');
}

function renderDebtTable() {
    const tbody = document.getElementById('debt-audit-body');
    const summaryEl = document.getElementById('debt-audit-summary');

    // Apply status filter client-side (data already loaded, no limit on server)
    const filtered = debtActiveFilter === 'all'
        ? debtAllSales
        : debtActiveFilter === 'paid'
            ? debtAllSales.filter(s => s.status === 'paid')
            : debtAllSales.filter(s => s.status !== 'paid'); // unpaid = partial + unpaid

    // Summary counts always reflect full dataset, not filtered view
    const totalCount  = debtAllSales.length;
    const openCount   = debtAllSales.filter(s => s.status !== 'paid').length;
    summaryEl.textContent = `${totalCount} total · ${openCount} open`;

    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4">No records found.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';

    filtered.forEach(sale => {
        const collapseId = `debt-collapse-${sale.sale_id}`;

        const statusBadge = {
            'paid':    `<span class="badge bg-success">PAID IN FULL</span>`,
            'partial': `<span class="badge bg-warning text-dark">PARTIAL</span>`,
            'unpaid':  `<span class="badge bg-danger">UNPAID</span>`,
        }[sale.status] || '';

        tbody.innerHTML += `
            <tr class="debt-parent-row ${sale.status === 'paid' ? 'opacity-75' : ''}"
                style="cursor: pointer;"
                onclick="toggleDebtRow('${collapseId}', ${sale.sale_id}, this)">
                <td class="text-center">
                    <i class="bi bi-chevron-down debt-chevron"></i>
                    <span class="debt-expand-hint">EXPAND</span>
                </td>
                <td class="fw-bold">${sale.customer_name}</td>
                <td class="text-warning">${sale.sales_number || sale.sale_id}</td>
                <td class="text-white-50 small">${sale.date}</td>
                <td class="text-end">₱${sale.total_amount.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                <td class="text-end text-success">₱${sale.total_paid.toLocaleString(undefined, {minimumFractionDigits:2})}</td>
                <td class="text-end ${sale.remaining > 0 ? 'text-danger fw-bold' : 'text-muted'}">
                    ₱${sale.remaining.toLocaleString(undefined, {minimumFractionDigits:2})}
                </td>
                <td class="text-center">${statusBadge}</td>
            </tr>
            <tr id="${collapseId}" style="display:none;">
                <td colspan="8" class="p-0 border-0">
                    <div id="${collapseId}-inner" style="background:#0d0f13;">
                        <div class="text-center text-muted py-3 small">
                            <i class="bi bi-hourglass-split me-1"></i> Loading payments...
                        </div>
                    </div>
                </td>
            </tr>`;
    });
}

function toggleDebtRow(collapseId, saleId, parentRow) {
    const row     = document.getElementById(collapseId);
    const chevron = parentRow.querySelector('.debt-chevron');
    const hint    = parentRow.querySelector('.debt-expand-hint');
    const isOpen  = row.style.display !== 'none';

    if (isOpen) {
        row.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
        if (hint) hint.textContent = 'EXPAND';
        return;
    }

    row.style.display = 'table-row';
    chevron.style.transform = 'rotate(180deg)';
    if (hint) hint.textContent = 'HIDE';

    const inner = document.getElementById(`${collapseId}-inner`);
    if (inner.dataset.loaded) return;

    fetch(`/api/debt/payments/${saleId}`)
        .then(r => r.json())
        .then(data => {
            if (!data.payments || data.payments.length === 0) {
                inner.innerHTML = '<div class="text-muted text-center py-2 small">No payment entries recorded yet.</div>';
                inner.dataset.loaded = '1';
                return;
            }

            const rows = data.payments.map(p => `
                <tr style="font-size: 0.82rem;">
                    <td></td>
                    <td class="text-white-50">${p.paid_at}</td>
                    <td class="text-info fw-bold">
                        ₱${parseFloat(p.amount_paid).toLocaleString(undefined, {minimumFractionDigits:2})}
                    </td>
                    <td colspan="3">
                        <span class="badge bg-dark border border-secondary text-info me-2">
                            ${p.payment_method || '—'}
                        </span>
                        <span class="text-white-50">${p.reference_no || ''}</span>
                    </td>
                    <td class="text-white-50">
                        <i class="bi bi-person me-1"></i>${p.paid_by || 'Staff'}
                    </td>
                    <td class="text-white-50 small fst-italic">${p.notes || ''}</td>
                </tr>`).join('');

            inner.innerHTML = `
                <table class="table table-dark mb-0 border-0">
                    <thead style="font-size:0.75rem;">
                        <tr class="text-muted">
                            <th width="3%"></th>
                            <th>Paid At</th>
                            <th>Amount</th>
                            <th colspan="3">Method & Reference</th>
                            <th>Staff</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>`;

            inner.dataset.loaded = '1';
        })
        .catch(() => {
            inner.innerHTML = '<div class="text-danger text-center py-2 small">Failed to load payments.</div>';
        });
}
</script>
{% endblock %}