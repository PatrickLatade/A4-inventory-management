{% extends "base.html" %}

{% block styles %}
<style>
    .admin-card {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .table-dark {
        background-color: #1e1e1e;
        border: 1px solid #333;
    }

    h2 {
        color: #e63946;
        margin-bottom: 1.5rem;
    }

    .role-badge {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Tabs dark theme */
    .nav-tabs .nav-link {
        background: #1a1a1a;
        border: 1px solid #333;
        color: #bbb;
        margin-right: 4px;
    }

    .nav-tabs .nav-link.active {
        background: #1e1e1e;
        color: #e63946;
        border-bottom-color: transparent;
        font-weight: bold;
    }

    .tab-content {
        background: #1e1e1e;
        border: 1px solid #333;
        border-top: none;
        padding: 1.5rem;
        border-radius: 0 0 8px 8px;
    }
    /* CRITICAL FIX: Prevent base.html and striped rows from hiding icons */
    .toggle-btn {
        background: none !important;
        border: none !important;
        padding: 0 !important;
        display: inline-flex !important;
        flex-direction: column;
        align-items: center;
        vertical-align: middle;
        position: relative;
        z-index: 2; /* Sits above the striped row background */
        transition: transform 0.2s ease-in-out;
    }

    .toggle-btn:hover {
        transform: scale(1.15);
        text-decoration: none !important;
    }

    /* Force the icon colors to stay vivid on dark backgrounds */
    .toggle-btn.text-success i {
        color: #28a745 !important;
        opacity: 1 !important;
    }

    .toggle-btn.text-muted i {
        color: #6c757d !important;
        opacity: 1 !important;
    }

    /* Small label adjustments */
    .toggle-btn small {
        font-size: 0.6rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        margin-top: -2px;
    }

    /* Fix for vanishing text labels */
    .toggle-btn.text-success small {
        color: #28a745 !important;
    }

    .toggle-btn.text-muted small {
        color: #6c757d !important;
    }

    #newCategoryInput:disabled {
    background-color: #121212 !important; /* Very dark/black background */
    color: #555 !important;              /* Dimmed text color */
    border-color: #333 !important;        /* Darker border */
    cursor: not-allowed;                  /* Shows the "stop" cursor */
    opacity: 1;                           /* Prevents browser-default transparency */
    }

    #newCategoryInput:not(:disabled) {
    border-color: #e63946; /* Match your red theme when active */
    }

    #newCategoryInput {
    transition: all 0.3s ease;
    }

    #newCategoryInput:required {
    border-left: 4px solid #e63946; /* Visual hint that this is now mandatory */
    }

    .audit-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 110px;
    height: 36px;
    font-weight: 600;
    font-size: 0.8rem;
    letter-spacing: 0.6px;
    border-radius: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-shield-lock-fill"></i> Admin Panel</h2>
    <a href="/" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left"></i> Back to Inventory
    </a>
</div>

<!-- TABS -->
<ul class="nav nav-tabs mb-0" role="tablist">
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'users-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#users-tab" type="button">
            <i class="bi bi-people-fill"></i> Users
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'mechanics-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#mechanics-tab" type="button">
            <i class="bi bi-tools"></i> Mechanics
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'manage-services-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#manage-services-tab" type="button">
            <i class="bi bi-gear-wide-connected"></i> Services
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'payment-methods-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#payment-methods-tab" type="button">
            <i class="bi bi-credit-card-2-front"></i> Payment Methods
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'sales-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#sales-tab" type="button">
            <i class="bi bi-cash-stack"></i> Sales
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link {% if active_tab == 'audit-tab' %}active{% endif %}" data-bs-toggle="tab" data-bs-target="#audit-tab" type="button">
            <i class="bi bi-clock-history"></i> Audit Trail
        </button>
    </li>
</ul>

<div class="tab-content">

    <!-- USERS TAB -->
    <div class="tab-pane fade {% if active_tab == 'users-tab' %}show active{% endif %}" id="users-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Create New Staff Account</h5>
            <form method="post" class="row g-3">
                <div class="col-md-5">
                    <input name="username" class="form-control" placeholder="New staff username" required>
                </div>
                <div class="col-md-5">
                    <input name="password" type="password" class="form-control" placeholder="Temporary password" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-person-plus-fill"></i> Create
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Created At</th>
                        <th>Created By</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td class="fw-bold">{{ user.username }}</td>
                        <td>
                            {% if user.role == 'admin' %}
                                <span class="badge bg-danger role-badge">Admin</span>
                            {% else %}
                                <span class="badge bg-secondary role-badge">Staff</span>
                            {% endif %}
                        </td>
                        <td class="text-white-50">{{ user.created_at }}</td>
                        <td class="text-white-50">
                            {% if user.creator_name %}
                                <i class="bi bi-person-badge"></i> {{ user.creator_name }}
                            {% else %}
                                <span class="text-muted small">System</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if user.role == 'admin' %}
                                <span class="text-success small fw-bold">
                                    <i class="bi bi-shield-check"></i> PROTECTED
                                </span>
                            {% else %}
                                <form action="{{ url_for('auth.toggle_user', user_id=user.id) }}" method="POST">
                                    {% if user.is_active == 1 %}
                                        <button type="submit" class="toggle-btn p-0 text-success">
                                            <i class="bi bi-toggle-on fs-4"></i>
                                            <small class="d-block">ACTIVE</small>
                                        </button>
                                    {% else %}
                                        <button type="submit" class="toggle-btn p-0 text-muted">
                                            <i class="bi bi-toggle-off fs-4"></i>
                                            <small class="d-block">DISABLED</small>
                                        </button>
                                    {% endif %}
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- MECHANICS TAB -->
    <div class="tab-pane fade {% if active_tab == 'mechanics-tab' %}show active{% endif %}" id="mechanics-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Add New Mechanic</h5>
            <form action="{{ url_for('auth.add_mechanic') }}" method="POST" class="row g-3">
                <div class="col-md-5">
                    <input name="name" class="form-control" placeholder="Mechanic Name" required>
                </div>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-dark border-secondary text-white-50">Rate</span>
                        <select name="commission" class="form-select border-secondary text-white bg-dark">
                            <option value="0.80">80%</option>
                            <option value="0.50">50%</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-2">
                    <input name="phone" class="form-control" placeholder="Phone #">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-plus-circle"></i> Add
                    </button>
                </div>
            </form>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Standard Rate</th>
                        <th>Phone</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mechanic in mechanics %}
                    <tr>
                        <td class="fw-bold">{{ mechanic.name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-warning">
                                {{ (mechanic.commission_rate * 100)|int }}%
                            </span>
                        </td>
                        <td class="text-white-50">{{ mechanic.phone or '---' }}</td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_mechanic', mechanic_id=mechanic.id) }}" method="POST">
                                {% if mechanic.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success" title="Click to Disable">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block fw-bold" style="font-size: 0.65rem;">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn p-0 text-muted" title="Click to Activate">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block fw-bold" style="font-size: 0.65rem;">INACTIVE</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center text-muted">No mechanics added yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SERVICES TAB -->
    <div class="tab-pane fade {% if active_tab == 'manage-services-tab' %}show active{% endif %}" id="manage-services-tab">
        <div class="admin-card shadow-sm">
            <h5 class="mb-3 text-white-50">Add New Labor/Service Type</h5>
            <form action="{{ url_for('auth.add_service') }}" method="POST" class="row g-3">
                <div class="col-md-4">
                    <input name="name" class="form-control" placeholder="Service Name (e.g. Brake Clean)" required>
                </div>
                <div class="col-md-3">
                    <select name="existing_category" id="categorySelect" class="form-select bg-dark text-white border-secondary">
                        <option value="Labor">Labor</option> 
                        {% for cat in categories %}
                            {% if cat.category != 'Labor' %}
                                <option value="{{ cat.category }}">{{ cat.category }}</option>
                            {% endif %}
                        {% endfor %}
                        <option value="__OTHER__">-- New Category --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input name="new_category" id="newCategoryInput" class="form-control" placeholder="Select '-- New Category --' to type" disabled>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>
            </form>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text bg-dark border-secondary text-white-50">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" id="serviceSearch" class="form-control bg-dark text-white border-secondary" 
                        placeholder="Search services (e.g. 'change oil')..." onkeyup="filterServices()">
                </div>
                <small class="text-muted">Showing up to 20 results from the master list.</small>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Service Name</th>
                        <th>Category</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody id="servicesBody">
                    {% for svc in services_list %}
                    <tr>
                        <td class="fw-bold">{{ svc.name }}</td>
                        <td><span class="badge bg-dark border border-secondary text-info">{{ svc.category }}</span></td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_service', service_id=svc.id) }}" method="POST">
                                {% if svc.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn text-muted">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block">DISABLED</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">No services configured yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAYMENT METHODS TAB -->
    <div class="tab-pane fade {% if active_tab == 'payment-methods-tab' %}show active{% endif %}" id="payment-methods-tab">

    <div class="admin-card shadow-sm">
        <h5 class="mb-3 text-white-50">Add New Payment Method</h5>
        <form action="{{ url_for('auth.add_payment_method') }}" method="POST" class="row g-3">
            <div class="col-md-6">
                <input name="name" class="form-control" placeholder="Payment Method Name (e.g. Metrobank)" required>
            </div>
            <div class="col-md-4">
                <select name="category" class="form-select bg-dark text-white border-secondary" required>
                    <option value="Bank">Bank</option>
                    <option value="Cash">Cash</option>
                    <option value="Debt">Debt</option>
                    <option value="Online">Online</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-danger w-100">
                    <i class="bi bi-plus-circle"></i> Add
                </button>
            </div>
        </form>
    </div>

        <div class="table-responsive">
            <table class="table table-dark table-striped align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pm in payment_methods %}
                    <tr>
                        <td class="fw-bold">{{ pm.name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-info">
                                {{ pm.category }}
                            </span>
                        </td>
                        <td class="text-center">
                            <form action="{{ url_for('auth.toggle_payment_method', pm_id=pm.id) }}" method="POST">
                                {% if pm.is_active == 1 %}
                                    <button type="submit" class="toggle-btn text-success">
                                        <i class="bi bi-toggle-on fs-3"></i>
                                        <small class="d-block">ACTIVE</small>
                                    </button>
                                {% else %}
                                    <button type="submit" class="toggle-btn text-muted">
                                        <i class="bi bi-toggle-off fs-3"></i>
                                        <small class="d-block">DISABLED</small>
                                    </button>
                                {% endif %}
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No payment methods configured yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- SALES TAB -->
    <div class="tab-pane fade {% if active_tab == 'sales-tab' %}show active{% endif %}" id="sales-tab">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead class="table-danger text-dark">
                    <tr>
                        <th>Date & Time</th>
                        <th>Receipt #</th>
                        <th>Customer</th>
                        <th>Payment</th>
                        <th>Total Amount</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_history %}
                    <tr>
                        <td class="text-white-50 small">{{ sale.transaction_date }}</td>
                        <td class="fw-bold text-warning">{{ sale.sales_number }}</td>
                        <td>{{ sale.customer_name }}</td>
                        <td>
                            <span class="badge bg-dark border border-secondary text-info">
                                {{ sale.payment_method_name }}
                            </span>
                        </td>
                        <td class="fw-bold text-danger">₱{{ "{:,.2f}".format(sale.total_amount) }}</td>
                        <td class="text-center">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-info me-1" 
                                    onclick="viewSaleDetails('{{ sale.id }}', '{{ sale.sales_number }}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            <a href="/print_receipt/{{ sale.sales_number }}" target="_blank" class="btn btn-sm btn-outline-warning">
                                <i class="bi bi-printer"></i>
                            </a>
                        </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted">No sales recorded yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- AUDIT TAB -->
    <div class="tab-pane fade {% if active_tab == 'audit-tab' %}show active{% endif %}" id="audit-tab">
        <div class="table-responsive">
            <h6 class="text-info fw-semibold fs-5 mt-4 mb-3">
            <i class="bi bi-truck me-2"></i> Item Movement
            </h6>
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr class="border-bottom border-secondary">
                        <th>Date & Time</th>
                        <th>Item Summary</th>
                        <th class="text-center">Movement</th>
                        <th>Reason</th>
                        <th class="text-center">Qty</th>
                        <th>Reference</th>
                        <th>Notes</th>
                        <th>Staff</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in history %}
                    <tr>
                        <td class="text-white-50 small">{{ log.transaction_date }}</td>
                        <td>
                            <div class="fw-bold text-white">{{ log.items_summary[:40] }}{% if log.items_summary|length > 40 %}...{% endif %}</div>
                        </td>
                        <td class="text-center">
                            {% set type = log.transaction_type|upper %}
                            
                            {# RED PILL: OUT #}
                            {% if type == 'SALE' or type == 'OUT' or type == 'REMOVE' %}
                                <span class="badge rounded-pill bg-danger audit-badge">
                                    <i class="bi bi-box-arrow-up me-1"></i> OUT
                                </span>

                            {# GREEN PILL: IN #}
                            {% elif type in ['RESTOCK', 'IN', 'ADD', 'RECEIVED'] %}
                                <span class="badge rounded-pill bg-success audit-badge">
                                    <i class="bi bi-box-arrow-in-down me-1"></i> IN
                                </span>

                            {# BLUE PILL: ORDER (New clipboard design) #}
                            {% elif type == 'ORDER' %}
                                <span class="badge rounded-pill bg-info text-dark audit-badge">
                                    <i class="bi bi-clipboard-check-fill me-1"></i> ORDER
                                </span>

                            {# GRAY PILL: Fallback #}
                            {% else %}
                                <span class="badge rounded-pill bg-secondary px-3 py-2" audit-badge">
                                    {{ log.transaction_type }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-white-50 small fst-italic fw-bold">
                                {{ log.change_reason and log.change_reason|replace('_', ' ') or '<span class="text-muted fw-bold">No reason provided</span>'|safe }}
                            </span>
                        </td>
                        <td class="text-center fw-bold">{{ log.total_qty }}</td>
                        <td>
                            {% if log.reference_id %}
                                {% if log.reference_type == 'PURCHASE_ORDER' %}
                                    <button class="btn btn-sm btn-outline-warning border-0 text-nowrap"
                                            style="white-space: nowrap;"
                                            onclick="viewOrder('{{ log.reference_id }}')">
                                        <i class="bi bi-box-seam me-1"></i>
                                        {{ log.po_number or log.reference_id }}
                                    </button>
                                {% else %}
                                    <button class="btn btn-sm btn-outline-danger border-0 text-nowrap"
                                            style="white-space: nowrap;"
                                            onclick="viewSaleDetails('{{ log.reference_id }}', '{{ log.sales_number or log.reference_id }}')">
                                        <i class="bi bi-receipt-cutoff"></i>
                                        {{ log.sales_number or log.reference_id }}
                                    </button>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">---</span>
                            {% endif %}
                        </td>
                        <td class="text-white-50 small">
                        {% if log.notes %}
                            <span class="text-info d-inline-block"
                                title="{{ log.notes }}"
                                style="max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; vertical-align: middle;">
                            <i class="bi bi-chat-left-text me-1"></i>{{ log.notes }}
                            </span>
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                        </td>
                        <td class="text-white-50 small"><i class="bi bi-person"></i> {{ log.user_name }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <h6 class="text-warning fw-semibold fs-5 mt-4 mb-3">
            <i class="bi bi-cash-coin me-2"></i> Debt Payment History
        </h6>
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle">
                <thead>
                    <tr class="border-bottom border-secondary">
                        <th>Paid At</th>
                        <th>Customer</th>
                        <th>Receipt #</th>
                        <th class="text-center">Amount Paid</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th>Staff</th>
                    </tr>
                </thead>
                <tbody id="debt-audit-body">
                    <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- SALES MODAL -->
    <div class="modal fade" id="saleDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-danger">Sale Details: #<span id="modalSaleID"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th class="text-center">Price (₱)</th>
                                <th class="text-center">Qty</th>
                            </tr>
                        </thead>
                        <tbody id="saleItemsList">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ORDERS MODAL -->
    <div class="modal fade" id="poDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white border-secondary">
        <div class="modal-header border-secondary">
            <h5 class="modal-title" id="poModalLabel">Purchase Order Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <!-- Header info -->
            <div class="row mb-4">
            <div class="col-6">
                <small class="text-white-50 d-block">PO NUMBER</small>
                <strong id="modal-po-number" class="text-danger fs-5"></strong>
            </div>
            <div class="col-6 text-end">
                <small class="text-white-50 d-block">STATUS</small>
                <span id="modal-po-status" class="badge"></span>
            </div>
            </div>

            <!-- Vendor & Dates -->
            <div class="row mb-4">
            <div class="col-6">
                <small class="text-white-50 d-block">VENDOR</small>
                <span id="modal-po-vendor"></span>
            </div>
            <div class="col-6 text-end">
                <small class="text-white-50 d-block">ORDER DATE</small>
                <span id="modal-po-order-date"></span>
                <br>
                <small class="text-white-50 d-block mt-2">RECEIVED DATE</small>
                <span id="modal-po-received-date"></span>
            </div>
            </div>

            <!-- Items table -->
            <table class="table table-dark table-hover border-secondary">
            <thead>
                <tr class="text-muted">
                <th>Item Name</th>
                <th class="text-center">Qty</th>
                <th class="text-end">Unit Price</th>
                <th class="text-end">Subtotal</th>
                </tr>
            </thead>
            <tbody id="po-items-list"></tbody>
            <tfoot>
                <tr class="border-top border-danger">
                <td colspan="3" class="fw-bold text-danger pt-3">GRAND TOTAL</td>
                <td id="modal-po-total" class="fw-bold text-danger text-end pt-3 fs-5"></td>
                </tr>
            </tfoot>
            </table>
        </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
let initialServicesHTML = "";
document.addEventListener('DOMContentLoaded', () => {
    initialServicesHTML = document.getElementById('servicesBody').innerHTML;
    
    syncCategoryFields();
});

    const categorySelect = document.getElementById('categorySelect');
    const newCategoryInput = document.getElementById('newCategoryInput');

function syncCategoryFields() {
    const categorySelect = document.getElementById('categorySelect');
    const newCategoryInput = document.getElementById('newCategoryInput');

    if (categorySelect.value === "__OTHER__") {
        // ENABLED STATE
        newCategoryInput.disabled = false;
        newCategoryInput.required = true; // Force validation
        newCategoryInput.placeholder = "Type new category name...";
        newCategoryInput.focus(); // Quality of Life: auto-focus for the user
    } else {
        // DISABLED STATE
        newCategoryInput.value = ""; 
        newCategoryInput.disabled = true;
        newCategoryInput.required = false; // Remove validation
        newCategoryInput.placeholder = "Select '-- New Category --' to type";
    }
}

categorySelect.addEventListener('change', syncCategoryFields);

let searchTimeout;
function filterServices() {
    const query = document.getElementById('serviceSearch').value.trim();
    const tbody = document.getElementById('servicesBody');

    // FIX: If the search box is empty, restore the original 20 items and stop
    if (query.length === 0) {
        tbody.innerHTML = initialServicesHTML;
        return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        // Optional: don't search for just 1 character to save server resources
        if (query.length < 1) return; 

        fetch(`/api/search/services?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                tbody.innerHTML = ''; 

                if (data.services.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No services found.</td></tr>';
                    return;
                }

                data.services.forEach(svc => {
                    let statusHtml = svc.is_active === 1 
                        ? `<button type="submit" class="toggle-btn text-success"><i class="bi bi-toggle-on fs-3"></i><small class="d-block">ACTIVE</small></button>`
                        : `<button type="submit" class="toggle-btn text-muted"><i class="bi bi-toggle-off fs-3"></i><small class="d-block">DISABLED</small></button>`;

                    tbody.innerHTML += `
                        <tr class="service-row">
                            <td class="fw-bold service-name">${svc.name}</td>
                            <td><span class="badge bg-dark border border-secondary text-info">${svc.category}</span></td>
                            <td class="text-center">
                                <form action="/services/toggle/${svc.id}" method="POST">
                                    ${statusHtml}
                                </form>
                            </td>
                        </tr>`;
                });
            });
    }, 300);
}

function viewSaleDetails(saleID, displayNum) {
    document.getElementById('modalSaleID').innerText = displayNum || saleID;
    const list = document.getElementById('saleItemsList');
    list.innerHTML = '<tr><td colspan="3" class="text-center">Loading...</td></tr>';
    
    const myModal = new bootstrap.Modal(document.getElementById('saleDetailsModal'));
    myModal.show();

    fetch(`/sales/details/${saleID}`)
        .then(response => response.json())
        .then(data => {
            list.innerHTML = '';
            
            // 1. Show Physical Items
            data.items.forEach(item => {
                let hasDisc = item.discount_amount && item.discount_amount > 0;
                let itemLabel = `<div>${item.name}</div>`;
                if(hasDisc) {
                    itemLabel += `<small class="text-success">Disc: -₱${item.discount_amount.toFixed(2)}</small>`;
                }
                
                let priceDisplay = `<div>₱${parseFloat(item.original_price).toFixed(2)}</div>`;
                if(hasDisc) {
                    priceDisplay += `<div class="text-success fw-bold">₱${parseFloat(item.final_unit_price).toFixed(2)}</div>`;
                }

                list.innerHTML += `
                    <tr>
                        <td>${itemLabel}</td>
                        <td class="text-center align-middle">${priceDisplay}</td>
                        <td class="text-center align-middle fw-bold text-warning">${item.quantity}</td>
                    </tr>`;
            });

            // 2. Show Services/Labor
            if(data.services && data.services.length > 0) {
                let mechanicLabel = data.mechanic ? ` (by ${data.mechanic})` : '';
                list.innerHTML += `<tr class="table-dark"><td colspan="3" class="text-info fw-bold border-top border-secondary">Labor & Services${mechanicLabel}</td></tr>`;
                data.services.forEach(svc => {
                    list.innerHTML += `
                        <tr>
                            <td>${svc.name}</td>
                            <td class="text-center">₱${parseFloat(svc.price).toFixed(2)}</td>
                            <td class="text-center text-muted">1</td>
                        </tr>`;
                });
            }

            // 3. The Golden Total Row with Payment Badge
            const badgeMap = {
            'Cash': 'bg-success',
            'Utang': 'bg-warning'
            };
            let badgeClass = badgeMap[data.payment_method] || 'bg-primary';
            
            list.innerHTML += `
                <tr class="border-top border-danger">
                    <td class="fw-bold pt-3 text-danger">
                        GRAND TOTAL 
                        <span class="badge ${badgeClass} ms-2" style="font-size: 0.65rem; vertical-align: middle;">
                            ${data.payment_method}
                        </span>
                    </td>
                    <td class="pt-3 fw-bold fs-5 text-danger text-center">
                        ₱${parseFloat(data.total_amount).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                    </td>
                    <td></td>
                </tr>`;
        });
}

function viewOrder(poId) {
    fetch(`/purchase-order/details/${poId}`)
        .then(response => response.json())
        .then(data => {
            const titleEl = document.getElementById('poModalLabel');
            const orderDateEl = document.getElementById('modal-po-order-date');
            const receivedDateEl = document.getElementById('modal-po-received-date');
            const statusEl = document.getElementById('modal-po-status');

            // Title stays generic
            titleEl.innerText = "Purchase Order Details";

            // Dates
            orderDateEl.innerText = data.created_at || '-';
            receivedDateEl.innerText = data.received_at || '-';

            // Status badge
            statusEl.innerText = data.status;
            statusEl.className = `badge ${data.status_class}`;

            // Other header fields
            document.getElementById('modal-po-number').innerText = data.po_number;
            document.getElementById('modal-po-vendor').innerText = data.vendor_name;
            document.getElementById('modal-po-total').innerText = '₱' + parseFloat(data.total_amount || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            // Itemized list
            const list = document.getElementById('po-items-list');
            list.innerHTML = data.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center">${item.quantity_ordered}</td>
                    <td class="text-end">₱${parseFloat(item.unit_price).toFixed(2)}</td>
                    <td class="text-end text-info">₱${parseFloat(item.subtotal).toFixed(2)}</td>
                </tr>
            `).join('');

            new bootstrap.Modal(document.getElementById('poDetailsModal')).show();
        })
        .catch(err => {
            console.error("Error fetching PO details:", err);
            alert("Failed to load order details. Please try again.");
        });
}

document.querySelector('[data-bs-target="#audit-tab"]').addEventListener('shown.bs.tab', function () {
    fetch('/api/debt/audit')
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('debt-audit-body');
            if (!data.payments || data.payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No debt payments recorded yet.</td></tr>';
                return;
            }
            tbody.innerHTML = data.payments.map(p => `
                <tr>
                    <td class="text-white-50 small">${p.paid_at}</td>
                    <td class="fw-bold">${p.customer_name || 'Walk-in'}</td>
                    <td class="text-warning">${p.sales_number || p.sale_id}</td>
                    <td class="text-center fw-bold text-success">₱${parseFloat(p.amount_paid).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                    <td><span class="badge bg-dark border border-secondary text-info">${p.payment_method || '—'}</span></td>
                    <td class="text-white-50 small">${p.reference_no || '—'}</td>
                    <td class="text-white-50 small"><i class="bi bi-person"></i> ${p.paid_by || 'Staff'}</td>
                </tr>
            `).join('');
        });
});
</script>
{% endblock %}