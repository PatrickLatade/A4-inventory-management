{% extends "base.html" %}

{% block styles %}
<style>
    /* Make the suggestions float above the table rows */
    .search-suggestions {
        border: 1px solid #444 !important;
        border-top: none !important;
        z-index: 9999 !important; /* Higher than everything else */
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    /* Style the buttons so they aren't bulky */
    .search-suggestions .list-group-item {
        padding: 8px 12px;
        border-bottom: 1px solid #333;
    }

    .search-suggestions .list-group-item:last-child {
        border-bottom: none;
    }

    /* Remove the parent table's scroll-hiding if it exists */
    .table-responsive {
        overflow: visible !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-white mb-4"><i class="bi bi-cart-dash text-danger"></i> New OUT Transaction</h1>

    <div class="card bg-dark text-white border-secondary shadow">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-white-50">Date / Time</label>
                    <input type="datetime-local" class="form-control bg-dark text-white border-secondary" id="trans-date">
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-white-50">Handled By</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" value="{{ session.get('username') }}" disabled>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-white-50">Customer</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" placeholder="Customer Name / Loyalty ID">
                </div>

                <hr class="my-4 border-secondary opacity-25">

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle" id="items-table">
                        <thead>
                            <tr class="small text-danger">
                                <th style="width: 40%;">Item</th>
                                <th style="width: 15%;">Stock</th>
                                <th style="width: 15%;">Qty OUT</th>
                                <th style="width: 15%;">Price</th>
                                <th style="width: 20%;">Subtotal</th>
                                <th style="width: 5%;"></th> </tr>
                            </tr>
                        </thead>
                        <tbody id="transaction-body">
                            <tr class="item-row">
                                <td>
                                    <div class="position-relative">
                                        <input type="text" 
                                            class="form-control form-control-sm bg-dark text-white border-secondary item-input" 
                                            placeholder="Search item..." 
                                            autocomplete="off">
                                        <div class="search-suggestions list-group position-absolute w-100 shadow-lg" 
                                            style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;">
                                        </div>
                                        <input type="hidden" class="item-id-input">
                                    </div>
                                </td>
                                <td><input type="text" class="form-control form-control-sm bg-dark text-white-50 border-secondary stock-input" value="--" disabled></td>
                                <td><input type="number" class="form-control form-control-sm bg-dark text-white border-secondary qty-input" min="1" value="1"></td>
                                <td><input type="number" class="form-control form-control-sm bg-dark text-white border-secondary price-input"></td>
                                <td class="text-warning fw-bold subtotal-display">₱0.00</td>
                                <td>
                                    <button type="button" class="btn btn-sm text-secondary remove-row-btn" tabindex="-1">×</button>
                                </td>
                            </tr>
                        </tbody>

                        <datalist id="items-datalist">
                            {% for item in items %}
                            <option value="{{ item.name }}" 
                                    data-price="{{ item.a4s_selling_price }}" 
                                    data-stock="{{ item.current_stock }}" 
                                    data-id="{{ item.id }}">
                                Stock: {{ item.current_stock }} | ₱{{ item.a4s_selling_price }}
                            </option>
                            {% endfor %}
                        </datalist>
                    </table>
                    <button class="btn btn-outline-danger btn-sm mt-2" id="add-row-btn">
                        <i class="bi bi-plus-circle"></i> Add Another Item
                    </button>
                </div>

                <hr class="my-4 border-secondary opacity-25">

                <div class="col-md-6">
                    <label class="form-label small text-white-50">Payment Type</label>
                    <select class="form-select bg-dark text-white border-secondary">
                        <option>Cash</option>
                        <option>GCash</option>
                        <option>Utang (Pay Later)</option>
                    </select>
                    <label class="form-label small text-white-50 mt-3">Notes</label>
                    <textarea class="form-control bg-dark text-white border-secondary" rows="2"></textarea>
                </div>

                <div class="col-md-6 d-flex flex-column justify-content-end align-items-end">
                    <h3 class="text-white-50 mb-0">TOTAL DUE</h3>
                    <h1 class="text-danger mb-4" id="grand-total">₱0.00</h1>
                    <button class="btn btn-danger btn-lg px-5 shadow">SUBMIT TRANSACTION</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Add the debounce function at the top if it's not already there
function debounce(func, delay) {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(null, args), delay);
    };
}

const handleTableSearch = async (inputElement) => {
    const query = inputElement.value.trim();
    const row = inputElement.closest('tr');
    const suggestionsBox = row.querySelector('.search-suggestions');

    if (query.length < 2) {
        suggestionsBox.style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        suggestionsBox.innerHTML = '';
        
        if (data.items && data.items.length > 0) {
            // LIMIT TO 5 RESULTS so it doesn't create a massive scroll
            const topResults = data.items.slice(0, 5); 

            topResults.forEach(item => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary small';
                
                // Clean layout: Name on top, stock/price on a tiny row below
                btn.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${item.name}</strong>
                        <span class="badge bg-danger">₱${item.a4s_selling_price}</span>
                    </div>
                    <small class="text-white-50" style="font-size: 0.7rem;">Stock: ${item.current_stock}</small>
                `;
                
                btn.onclick = () => {
                    inputElement.value = item.name;
                    row.querySelector('.item-id-input').value = item.id;
                    row.querySelector('.price-input').value = item.a4s_selling_price;
                    row.querySelector('.stock-input').value = item.current_stock;
                    suggestionsBox.style.display = 'none';
                    calculateRow(row);
                };
                suggestionsBox.appendChild(btn);
            });
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    } catch (err) {
        console.error("Search error:", err);
    }
};

// Wire up the input listener
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('item-input')) {
        debounce(() => handleTableSearch(e.target), 300)();
    }
    
    // Keep your existing Qty/Price manual override listeners
    if (e.target.classList.contains('qty-input') || e.target.classList.contains('price-input')) {
        calculateRow(e.target.closest('tr'));
    }
});

// Hide suggestions when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('item-input')) {
        document.querySelectorAll('.search-suggestions').forEach(box => {
            box.style.display = 'none';
        });
    }
});

// 3. Handle Row Removal
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-row-btn')) {
        const row = e.target.closest('tr');
        const allRows = document.querySelectorAll('.item-row');
        
        // Don't delete the last remaining row, just clear it
        if (allRows.length > 1) {
            row.remove();
            calculateGrandTotal();
        } else {
            row.querySelector('.item-input').value = '';
            row.querySelector('.price-input').value = '';
            row.querySelector('.stock-input').value = '--';
            calculateRow(row);
        }
    }
});

function calculateRow(row) {
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const price = parseFloat(row.querySelector('.price-input').value) || 0;
    const subtotal = qty * price;
    row.querySelector('.subtotal-display').innerText = `₱${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    calculateGrandTotal();
}

function calculateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal-display').forEach(display => {
        const val = parseFloat(display.innerText.replace(/[₱,]/g, '')) || 0;
        total += val;
    });
    document.getElementById('grand-total').innerText = `₱${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
}

document.getElementById('add-row-btn').addEventListener('click', function(e) {
    e.preventDefault();
    const tbody = document.getElementById('transaction-body');
    const firstRow = tbody.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear everything for the new row
    newRow.querySelector('.item-input').value = '';
    newRow.querySelector('.price-input').value = '';
    newRow.querySelector('.qty-input').value = 1;
    newRow.querySelector('.stock-input').value = '--';
    newRow.querySelector('.subtotal-display').innerText = '₱0.00';
    
    tbody.appendChild(newRow);
});
</script>

{% endblock %}