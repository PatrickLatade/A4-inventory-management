{% extends "base.html" %}

{% block styles %}
<style>
    /* Make the suggestions float above the table rows */
    .search-suggestions {
        border: 1px solid #444 !important;
        border-top: none !important;
        z-index: 9999 !important; /* Higher than everything else */
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    /* Style the buttons so they aren't bulky */
    .search-suggestions .list-group-item {
        padding: 8px 12px;
        border-bottom: 1px solid #333;
    }

    .search-suggestions .list-group-item:last-child {
        border-bottom: none;
    }

    /* Remove the parent table's scroll-hiding if it exists */
    .table-responsive {
        overflow: visible !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-white mb-4"><i class="bi bi-cart-dash text-danger"></i> New OUT Transaction</h1>

    <div class="card bg-dark text-white border-secondary shadow">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label small text-white-50">Date / Time</label>
                    <input type="datetime-local" class="form-control bg-dark text-white border-secondary" id="trans-date">
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-white-50">Handled By</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" value="{{ session.get('username') }}" disabled>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-warning">Paper Receipt # (Sales Number)</label>
                    <input type="text" class="form-control bg-dark text-white border-warning" id="sales-number" placeholder="e.g. 4052">
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-white-50">Customer</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" placeholder="Customer Name / Loyalty ID">
                </div>

                <hr class="my-4 border-secondary opacity-25">

                <div class="table-responsive">
                    <table class="table table-dark table-hover align-middle" id="items-table">
                        <thead>
                            <tr class="small text-danger">
                                <th style="width: 40%;">Item</th>
                                <th style="width: 15%;">Stock</th>
                                <th style="width: 15%;">Qty OUT</th>
                                <th style="width: 15%;">Price</th>
                                <th style="width: 20%;">Subtotal</th>
                                <th style="width: 5%;"></th> </tr>
                            </tr>
                        </thead>
                        <tbody id="transaction-body">
                            <tr class="item-row">
                                <td>
                                    <div class="position-relative">
                                        <input type="text" 
                                            class="form-control form-control-sm bg-dark text-white border-secondary item-input" 
                                            placeholder="Search item..." 
                                            autocomplete="off">
                                        <div class="search-suggestions list-group position-absolute w-100 shadow-lg" 
                                            style="z-index: 1000; display: none; max-height: 200px; overflow-y: auto;">
                                        </div>
                                        <input type="hidden" class="item-id-input">
                                    </div>
                                </td>
                                <td><input type="text" class="form-control form-control-sm bg-dark text-white-50 border-secondary stock-input" value="--" disabled></td>
                                <td><input type="number" class="form-control form-control-sm bg-dark text-white border-secondary qty-input" min="1" value="1"></td>
                                <td><input type="number" class="form-control form-control-sm bg-dark text-white border-secondary price-input"></td>
                                <td class="text-warning fw-bold subtotal-display">₱0.00</td>
                                <td>
                                    <button type="button" class="btn btn-sm text-secondary remove-row-btn" tabindex="-1">×</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <button class="btn btn-outline-danger btn-sm mt-2" id="add-row-btn">
                        <i class="bi bi-plus-circle"></i> Add Another Item
                    </button>
                </div>

                <hr class="my-4 border-secondary opacity-25">

                <div class="col-md-6">
                    <label class="form-label small text-white-50">Payment Category</label>
                    <select class="form-select bg-dark text-white border-secondary" id="payment-category">
                        <option value="1" data-status="Paid">Cash</option>
                        <option value="Online" data-status="Paid">Online Payment</option>
                        <option value="5" data-status="Unresolved">Utang (Pay Later)</option>
                    </select>

                    <div id="online-options" class="mt-3" style="display: none;">
                        <label class="form-label small text-info">Select Online Provider</label>
                        <select class="form-select bg-dark text-white border-info" id="payment-method">
                            {% for method in payment_methods %}
                                {% if method.category == 'Online' %}
                                <option value="{{ method.id }}">{{ method.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <input type="text" class="form-control bg-dark text-white border-info mt-2" placeholder="Reference Number (Optional)" id="ref-no">
                    </div>

                    <label class="form-label small text-white-50 mt-3">Notes</label>
                    <textarea class="form-control bg-dark text-white border-secondary" rows="2" id="trans-notes"></textarea>
                </div>

                <div class="col-md-6 d-flex flex-column justify-content-end align-items-end">
                    <h3 class="text-white-50 mb-0">TOTAL DUE</h3>
                    <h1 class="text-danger mb-4" id="grand-total">₱0.00</h1>
                    <button id="submit-btn" class="btn btn-danger btn-lg px-5 shadow" disabled>SUBMIT TRANSACTION</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('trans-date');
    
    // Create a date object for "Now" in the local timezone
    const now = new Date();
    
    // Offset calculation to force Local Time instead of UTC
    const offset = now.getTimezoneOffset() * 60000; 
    const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);
    
    dateInput.value = localISOTime;
});

document.getElementById('submit-btn').addEventListener('click', async function(e) {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> SAVING...';
    e.preventDefault(); // Stop the page from refreshing

    // 1. THE FINAL GUARD: Double-check everything
    const rows = document.querySelectorAll('.item-row');
    let validItems = [];
    let isDataClean = true;

    rows.forEach(row => {
        const itemId = row.querySelector('.item-id-input').value;
        const qty = parseFloat(row.querySelector('.qty-input').value);
        const itemName = row.querySelector('.item-input').value;

        // If there's text in the box but NO ID, it's a "Ghost Item"
        if (itemName.trim() !== "" && !itemId) {
            isDataClean = false;
        }

        if (itemId && qty > 0) {
            validItems.push({
                item_id: itemId,
                quantity: qty,
                price: row.querySelector('.price-input').value
            });
        }
    });

    if (!isDataClean || validItems.length === 0) {
        alert("Wait! Some items are invalid or the cart is empty. Please fix them before submitting.");
        return; // KILL THE PROCESS HERE
    }

    // 2. If we got here, the data is officially "Locked and Loaded"
    console.log("Data is clean! Proceeding to save...");
    
    // This is where we will call the save function next
    await saveTransaction(validItems); 
});

document.getElementById('payment-category').addEventListener('change', function() {
    const category = this.value;
    const onlineDiv = document.getElementById('online-options');
    const submitBtn = document.querySelector('.btn-lg'); // The Submit button

    if (category === 'Online') {
        onlineDiv.style.display = 'block';
        submitBtn.classList.replace('btn-danger', 'btn-info'); // Change color for visual cue
    } else if (category === '5') {
        onlineDiv.style.display = 'none';
        submitBtn.classList.replace('btn-info', 'btn-warning'); // Warning yellow for Utang
        submitBtn.classList.replace('btn-danger', 'btn-warning');
    } else {
        onlineDiv.style.display = 'none';
        submitBtn.className = 'btn btn-danger btn-lg px-5 shadow'; // Reset to red
    }
});

// Add the debounce function at the top if it's not already there
function debounce(func, delay) {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(null, args), delay);
    };
}

const handleTableSearch = async (inputElement) => {
    const query = inputElement.value.trim();
    const row = inputElement.closest('tr');
    const suggestionsBox = row.querySelector('.search-suggestions');
    const idInput = row.querySelector('.item-id-input');

    if (inputElement.dataset.confirmedName !== query) {
        idInput.value = '';
        row.querySelector('.price-input').value = '';
        row.querySelector('.stock-input').value = '--';
        calculateRow(row);
    }

    if (query.length < 2) {
        suggestionsBox.style.display = 'none';
        return;
    }

    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        suggestionsBox.innerHTML = '';
        
        if (data.items && data.items.length > 0) {
            // LIMIT TO 5 RESULTS so it doesn't create a massive scroll
            const topResults = data.items.slice(0, 5); 

            topResults.forEach(item => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary small';
                
                // Clean layout: Name on top, stock/price on a tiny row below
                btn.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>${item.name}</strong>
                        <span class="badge bg-danger">₱${item.a4s_selling_price}</span>
                    </div>
                    <small class="text-white-50" style="font-size: 0.7rem;">Stock: ${item.current_stock}</small>
                `;
                
                btn.onclick = () => {
                    inputElement.value = item.name;
                    inputElement.dataset.confirmedName = item.name;
                    row.querySelector('.item-id-input').value = item.id;
                    row.querySelector('.price-input').value = item.a4s_selling_price;
                    row.querySelector('.stock-input').value = item.current_stock;
                    suggestionsBox.style.display = 'none';
                    calculateRow(row);
                };
                suggestionsBox.appendChild(btn);
            });
            suggestionsBox.style.display = 'block';
        } else {
            suggestionsBox.style.display = 'none';
        }
    } catch (err) {
        console.error("Search error:", err);
    }
};

// Wire up the input listener
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('item-input')) {
        debounce(() => handleTableSearch(e.target), 300)();
    }
    
    // Keep your existing Qty/Price manual override listeners
    if (e.target.classList.contains('qty-input') || e.target.classList.contains('price-input')) {
        calculateRow(e.target.closest('tr'));
    }
});

// Hide suggestions when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.classList.contains('item-input')) {
        document.querySelectorAll('.search-suggestions').forEach(box => {
            box.style.display = 'none';
        });
    }
});

// 3. Handle Row Removal
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-row-btn')) {
        const row = e.target.closest('tr');
        const allRows = document.querySelectorAll('.item-row');
        
        // Don't delete the last remaining row, just clear it
        if (allRows.length > 1) {
            row.remove();
            calculateGrandTotal();
        } else {
            row.querySelector('.item-input').value = '';
            row.querySelector('.price-input').value = '';
            row.querySelector('.stock-input').value = '--';
            calculateRow(row);
        }
    }
});

function validateForm() {
    const submitBtn = document.getElementById('submit-btn');
    let hasValidItem = false;

    // Check if at least one row has an Item ID selected
    document.querySelectorAll('.item-id-input').forEach(idInput => {
        if (idInput.value !== "") {
            hasValidItem = true;
        }
    });

    submitBtn.disabled = !hasValidItem;
}

function calculateRow(row) {
    const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
    const price = parseFloat(row.querySelector('.price-input').value) || 0;
    const subtotal = qty * price;
    row.querySelector('.subtotal-display').innerText = `₱${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    calculateGrandTotal();
}

function calculateGrandTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal-display').forEach(display => {
        const val = parseFloat(display.innerText.replace(/[₱,]/g, '')) || 0;
        total += val;
    });
    document.getElementById('grand-total').innerText = `₱${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
    validateForm();
}

document.getElementById('add-row-btn').addEventListener('click', function(e) {
    e.preventDefault();
    const tbody = document.getElementById('transaction-body');
    const firstRow = tbody.querySelector('.item-row');
    const newRow = firstRow.cloneNode(true);
    
    // Clear everything for the new row
    newRow.querySelector('.item-input').value = '';
    newRow.querySelector('.price-input').value = '';
    newRow.querySelector('.qty-input').value = 1;
    newRow.querySelector('.stock-input').value = '--';
    newRow.querySelector('.subtotal-display').innerText = '₱0.00';
    
    tbody.appendChild(newRow);
});

async function saveTransaction(validItems) {
    // 1. Collect the "Header" information
    const paymentCategory = document.getElementById('payment-category');
    let finalPaymentId = paymentCategory.value;

    // If 'Online' was selected, get the specific provider ID (GCash/Maya)
    if (finalPaymentId === "Online") {
        finalPaymentId = document.getElementById('payment-method').value;
    }

    const payload = {
        sales_number: document.getElementById('sales-number').value,
        customer_name: document.querySelector('input[placeholder="Customer Name / Loyalty ID"]').value,
        payment_method_id: finalPaymentId,
        total_amount: parseFloat(document.getElementById('grand-total').innerText.replace(/[₱,]/g, '')),
        notes: document.getElementById('trans-notes').value,
        transaction_date: document.getElementById('trans-date').value,
        items: validItems // This is the array we built in the click listener
    };

    // 2. Send it to the server
    try {
        const response = await fetch('/transaction/out/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            window.location.href = "/transaction/out"; // Or wherever you want to go
        } else {
            const result = await response.json();
            alert("Error: " + result.message);
        }
    } catch (error) {
        console.error("Submission failed:", error);
    }
}
</script>

{% endblock %}